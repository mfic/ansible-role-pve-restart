---
# tasks/reboot_node.yml
# Performs a full OS reboot and waits for PVE services to come back.
# This file is also reused by mfic.pve-update via include_role.

- name: Reboot — perform OS reboot
  ansible.builtin.reboot:
    msg: "{{ pve_restart_reboot_msg }}"
    pre_reboot_delay: "{{ pve_restart_pre_reboot_delay }}"
    post_reboot_delay: "{{ pve_restart_post_reboot_delay }}"
    reboot_timeout: "{{ pve_restart_reboot_timeout }}"
    test_command: uptime

- name: Reboot — reset SSH connection after reboot
  ansible.builtin.meta: reset_connection

- name: Reboot — wait for PVE services and quorum
  ansible.builtin.shell: |
    systemctl is-active --quiet pve-cluster && timeout 10 pvecm status
  register: _pvecm_post_reboot
  changed_when: false
  until: _pvecm_post_reboot.rc == 0 and _pvecm_post_reboot.stdout is search('Quorate:\s+Yes')
  retries: "{{ pve_restart_service_ready_retries }}"
  delay: "{{ pve_restart_service_ready_delay }}"
