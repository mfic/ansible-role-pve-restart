---
# tasks/evacuate_node.yml
# Evacuates all workloads off the current node before reboot.
# Three phases: HA maintenance mode, non-HA workload migration, Ceph noout.

# --- HA maintenance mode ---

- name: Evacuate — enable HA maintenance mode
  ansible.builtin.command: ha-manager crm-command node-maintenance enable {{ _pve_node_name }}
  changed_when: true
  when: pve_restart_ha_maintenance_enabled | bool

- name: Evacuate — wait for HA resources to leave this node
  ansible.builtin.shell: |
    ha-manager status | awk -v node="{{ _pve_node_name }}" '$0 ~ node && /started/ {print}'
  register: _pve_ha_on_node
  changed_when: false
  until: _pve_ha_on_node.stdout | trim | length == 0
  retries: "{{ pve_restart_ha_maintenance_poll_retries }}"
  delay: "{{ pve_restart_ha_maintenance_poll_delay }}"
  when: pve_restart_ha_maintenance_enabled | bool
  ignore_errors: true

# --- Shut down pinned HA VMs/CTs that could not migrate ---

- name: Evacuate — find HA VMs still running on this node
  ansible.builtin.shell: |
    ha-manager status | awk -v node="{{ _pve_node_name }}" '/^service vm:/ && $0 ~ node && /started/ {split($2, a, ":"); print a[2]}'
  register: _pve_pinned_ha_vms
  changed_when: false
  when:
    - pve_restart_ha_maintenance_enabled | bool
    - _pve_ha_on_node.stdout | default('') | trim | length > 0

- name: Evacuate — shut down pinned HA VMs
  ansible.builtin.command: >
    qm shutdown {{ item }} --forceStop 1 --timeout {{ pve_restart_shutdown_timeout }}
  loop: "{{ _pve_pinned_ha_vms.stdout_lines | default([]) }}"
  when:
    - pve_restart_ha_maintenance_enabled | bool
    - _pve_pinned_ha_vms.stdout_lines | default([]) | length > 0
  changed_when: true

- name: Evacuate — find HA CTs still running on this node
  ansible.builtin.shell: |
    ha-manager status | awk -v node="{{ _pve_node_name }}" '/^service ct:/ && $0 ~ node && /started/ {split($2, a, ":"); print a[2]}'
  register: _pve_pinned_ha_cts
  changed_when: false
  when:
    - pve_restart_ha_maintenance_enabled | bool
    - _pve_ha_on_node.stdout | default('') | trim | length > 0

- name: Evacuate — shut down pinned HA CTs
  ansible.builtin.command: >
    pct shutdown {{ item }} --timeout {{ pve_restart_shutdown_timeout }}
  loop: "{{ _pve_pinned_ha_cts.stdout_lines | default([]) }}"
  when:
    - pve_restart_ha_maintenance_enabled | bool
    - _pve_pinned_ha_cts.stdout_lines | default([]) | length > 0
  changed_when: true

# --- Non-HA VMs ---

- name: Evacuate — list running VMs on this node
  ansible.builtin.shell: |
    qm list | awk 'NR>1 && $3 == "running" {print $1}'
  register: _pve_running_vms
  changed_when: false

- name: Evacuate — list HA-managed VM IDs
  ansible.builtin.shell: |
    ha-manager status | awk -F'[: ]' '/^service vm:/ {print $3}'
  register: _pve_ha_vm_ids
  changed_when: false
  when: pve_restart_ha_maintenance_enabled | bool

- name: Evacuate — default HA VM list when HA is disabled
  ansible.builtin.set_fact:
    _pve_ha_vm_ids:
      stdout_lines: []
  when: not (pve_restart_ha_maintenance_enabled | bool)

- name: Evacuate — determine non-HA running VMs
  ansible.builtin.set_fact:
    _pve_non_ha_vms: >-
      {{ _pve_running_vms.stdout_lines | default([])
         | difference(_pve_ha_vm_ids.stdout_lines | default([])) }}

- name: Evacuate — set migration target node
  ansible.builtin.set_fact:
    _pve_migration_target: >-
      {{ groups[pve_restart_cluster_group]
         | difference([inventory_hostname]) | first }}
  when: (_pve_non_ha_vms | length > 0) or (_pve_running_cts | default([]) | length > 0)

- name: Evacuate — live-migrate non-HA VMs
  ansible.builtin.command: >
    qm migrate {{ item }} {{ _pve_migration_target }} --online
  loop: "{{ _pve_non_ha_vms }}"
  when:
    - pve_restart_migrate_non_ha | bool
    - _pve_non_ha_vms | length > 0
  changed_when: true
  register: _pve_vm_migrate_results
  ignore_errors: true

- name: Evacuate — shut down VMs that failed to migrate
  ansible.builtin.command: >
    qm shutdown {{ item.item }} --forceStop 1 --timeout {{ pve_restart_shutdown_timeout }}
  loop: "{{ _pve_vm_migrate_results.results | default([]) }}"
  when:
    - _pve_vm_migrate_results.results is defined
    - item.failed | default(false)
  loop_control:
    label: "{{ item.item | default('n/a') }}"
  changed_when: true

# --- Non-HA CTs ---

- name: Evacuate — list running CTs on this node
  ansible.builtin.shell: |
    pct list | awk 'NR>1 && $2 == "running" {print $1}'
  register: _pve_running_cts
  changed_when: false

- name: Evacuate — list HA-managed CT IDs
  ansible.builtin.shell: |
    ha-manager status | awk -F'[: ]' '/^service ct:/ {print $3}'
  register: _pve_ha_ct_ids
  changed_when: false
  when: pve_restart_ha_maintenance_enabled | bool

- name: Evacuate — default HA CT list when HA is disabled
  ansible.builtin.set_fact:
    _pve_ha_ct_ids:
      stdout_lines: []
  when: not (pve_restart_ha_maintenance_enabled | bool)

- name: Evacuate — determine non-HA running CTs
  ansible.builtin.set_fact:
    _pve_non_ha_cts: >-
      {{ _pve_running_cts.stdout_lines | default([])
         | difference(_pve_ha_ct_ids.stdout_lines | default([])) }}

- name: Evacuate — set migration target for CTs
  ansible.builtin.set_fact:
    _pve_migration_target: >-
      {{ groups[pve_restart_cluster_group]
         | difference([inventory_hostname]) | first }}
  when:
    - _pve_migration_target is not defined
    - _pve_non_ha_cts | length > 0

- name: Evacuate — migrate non-HA CTs
  ansible.builtin.command: >
    pct migrate {{ item }} {{ _pve_migration_target }}
    --restart --timeout {{ pve_restart_migration_timeout }}
  loop: "{{ _pve_non_ha_cts }}"
  when:
    - pve_restart_migrate_non_ha | bool
    - _pve_non_ha_cts | length > 0
  changed_when: true
  register: _pve_ct_migrate_results
  ignore_errors: true

- name: Evacuate — shut down CTs that failed to migrate
  ansible.builtin.command: >
    pct shutdown {{ item.item }} --timeout {{ pve_restart_shutdown_timeout }}
  loop: "{{ _pve_ct_migrate_results.results | default([]) }}"
  when:
    - _pve_ct_migrate_results.results is defined
    - item.failed | default(false)
  loop_control:
    label: "{{ item.item | default('n/a') }}"
  changed_when: true

# --- Ceph ---

- name: Evacuate — set Ceph OSD noout for this node
  ansible.builtin.command: ceph osd set-group noout {{ _pve_node_name }}
  changed_when: true
  when: pve_restart_ceph_enabled | bool

- name: Evacuate — pause for Ceph noout to settle
  ansible.builtin.pause:
    seconds: "{{ pve_restart_ceph_noout_settle_delay }}"
  when: pve_restart_ceph_enabled | bool

# --- Final check ---

- name: Evacuate — verify no VMs remain running on this node
  ansible.builtin.shell: |
    qm list | awk 'NR>1 && $3 == "running" {print $1}'
  register: _pve_remaining_vms
  changed_when: false
  until: _pve_remaining_vms.stdout | trim | length == 0
  retries: 20
  delay: 15

- name: Evacuate — verify no CTs remain running on this node
  ansible.builtin.shell: |
    pct list | awk 'NR>1 && $2 == "running" {print $1}'
  register: _pve_remaining_cts
  changed_when: false
  until: _pve_remaining_cts.stdout | trim | length == 0
  retries: 20
  delay: 15
