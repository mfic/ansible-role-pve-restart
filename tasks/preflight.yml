---
# tasks/preflight.yml
# Runs once per play. Validates the PVE cluster is healthy before
# touching any node.

- name: Preflight — log PVE version
  ansible.builtin.command: pveversion
  register: _pve_version
  changed_when: false
  run_once: true

- name: Preflight — show PVE version
  ansible.builtin.debug:
    msg: "{{ _pve_version.stdout }}"
  run_once: true

- name: Preflight — check cluster quorum
  ansible.builtin.command: pvecm status
  register: _pvecm_status
  changed_when: false
  run_once: true
  failed_when: _pvecm_status.stdout is not search('Quorate:\s+Yes')

- name: Preflight — get PVE node list
  ansible.builtin.shell: |
    pvesh get /nodes --output-format json |
      python3 -c "import sys,json;[print(n['node']) for n in json.load(sys.stdin)]"
  register: _pve_nodes
  changed_when: false
  run_once: true

- name: Preflight — verify expected node count
  ansible.builtin.assert:
    that:
      - _pve_nodes.stdout_lines | length == groups[pve_restart_cluster_group] | length
    fail_msg: >-
      Expected {{ groups[pve_restart_cluster_group] | length }} PVE nodes
      but pvesh reports {{ _pve_nodes.stdout_lines | length }}:
      {{ _pve_nodes.stdout_lines | join(', ') }}
  run_once: true

- name: Preflight — check all nodes are online
  ansible.builtin.shell: |
    pvesh get /nodes --output-format json |
      python3 -c "import sys,json;[print(n['node']) for n in json.load(sys.stdin) if n.get('status')!='online']"
  register: _pve_offline_nodes
  changed_when: false
  run_once: true
  failed_when: _pve_offline_nodes.stdout | trim | length > 0
