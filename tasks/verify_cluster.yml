---
# tasks/verify_cluster.yml
# Post-reboot health check. Validates the cluster is operational
# after this node has been rebooted and restored.

- name: Verify — check cluster quorum
  ansible.builtin.command: pvecm status
  register: _pvecm_verify
  changed_when: false
  until: _pvecm_verify.stdout is search('Quorate:\s+Yes')
  retries: 20
  delay: 15

- name: Verify — check all PVE nodes are online
  ansible.builtin.shell: |
    pvesh get /nodes --output-format json |
      python3 -c "import sys,json;[print(n['node']) for n in json.load(sys.stdin) if n.get('status')!='online']"
  register: _pve_verify_offline
  changed_when: false
  until: _pve_verify_offline.stdout | trim | length == 0
  retries: 20
  delay: 15

- name: Verify — check Ceph health
  ansible.builtin.command: ceph health
  register: _ceph_health
  changed_when: false
  until: _ceph_health.stdout is search('HEALTH_OK|HEALTH_WARN')
  retries: 40
  delay: 15
  when: pve_restart_ceph_enabled | bool
